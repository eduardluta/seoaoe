name: Weekly Application Ping

# Runs every Monday at 9:00 AM UTC
# Can also be triggered manually from the Actions tab
on:
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Monday at 9:00 AM UTC
  workflow_dispatch:  # Allows manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ping deployed application
        env:
          APP_URL: ${{ secrets.APP_URL || 'https://seoaoe.com' }}
        run: |
          echo "Pinging application at: $APP_URL"

          # Retry logic: try up to 3 times with 5 second delays
          max_attempts=3
          attempt=1
          success=false

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."

            # Ping the application and capture HTTP status code
            http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$APP_URL")

            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
              echo "‚úÖ Success! Application responded with HTTP $http_code"
              success=true
              break
            else
              echo "‚ùå Failed with HTTP $http_code"

              if [ $attempt -lt $max_attempts ]; then
                echo "Waiting 5 seconds before retry..."
                sleep 5
              fi
            fi

            attempt=$((attempt + 1))
          done

          if [ "$success" = false ]; then
            echo "::error::Application ping failed after $max_attempts attempts"
            exit 1
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Weekly Ping Failed';
            const body = `The weekly application ping failed on ${new Date().toISOString()}.

            **Details:**
            - Workflow: ${context.workflow}
            - Run: ${context.runNumber}
            - URL: [View Run](${context.payload.repository.html_url}/actions/runs/${context.runId})

            Please check the application health and deployment status.`;

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ping-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ping-failure', 'automated']
              });
            } else {
              // Add a comment to the existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Another ping failure occurred on ${new Date().toISOString()}.\n\n[View Run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
            }
